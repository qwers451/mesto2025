(()=>{"use strict";const e=document.querySelector("#card-template").content,t=(t,r,o,n)=>{const s=e.querySelector(".places__item").cloneNode(!0),a=s.querySelector(".card__image"),c=s.querySelector(".card__title"),l=s.querySelector(".card__like-count");return c.textContent=r,a.src=t,a.alt=r,l.textContent=o,s.id=n,s},r=(e,t,r,o,n)=>{const s=e.querySelector(`.${t.name}-error`);t.classList.add(r),s.classList.add(n),s.textContent=o},o=(e,t,r,o)=>{const n=e.querySelector(`.${t.name}-error`);t.classList.remove(r),n.classList.remove(o),n.textContent=""},n=(e,t,n)=>{const s=t.validity.valid?"":t.validationMessage;"url"===t.type?t.validity.valid&&(e=>{try{const t=new URL(e),r=t.hostname.split(".");return("http:"===t.protocol||"https:"===t.protocol)&&r.length>1&&r[r.length-1].length>=2}catch(e){return!1}})(t.value)?o(e,t,n.inputErrorClass,n.errorClass):r(e,t,n.inputErrorClass,s||"Некорректный URL",n.errorClass):t.validity.valid?o(e,t,n.inputErrorClass,n.errorClass):r(e,t,n.inputErrorClass,s,n.errorClass)},s=(e,t)=>{const r=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);a(r,o,t.inactiveButtonClass),r.forEach((r=>{n(e,r,t)}))},a=(e,t,r)=>{(e=>e.some((e=>!e.validity.valid)))(e)?t.classList.add(r):t.classList.remove(r)};function c(e){"Escape"===e.key&&m(document.querySelector(".popup_is-opened"))}let l=!1;function u(e){l=e.target===e.currentTarget}function i(e){e.target!==e.currentTarget&&(l=!1)}function d(e){e.target===e.currentTarget&&(e.target.style.cursor="pointer")}function p(e){e.target===e.currentTarget&&(e.target.style.cursor="default")}function _(e){function t(){m(e),e.querySelector(".popup__close").removeEventListener("click",t),e.removeEventListener("click",r),e.removeEventListener("mousedown",u),e.removeEventListener("mouseup",i),e.removeEventListener("mouseover",d),e.removeEventListener("mouseout",p),document.removeEventListener("keydown",c)}function r(e){l&&e.target===e.currentTarget&&t()}e.classList.add("popup_is-opened"),e.querySelector(".popup__close").addEventListener("click",t),e.addEventListener("click",r),e.addEventListener("mousedown",u),e.addEventListener("mouseup",i),e.addEventListener("mouseover",d),e.addEventListener("mouseout",p),document.addEventListener("keydown",c)}function m(e){e.classList.remove("popup_is-opened")}const v={baseUrl:"https://nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"552fa201-4f17-4a86-bad1-b606f4eb72fe","Content-Type":"application/json"}},y=document.querySelector(".profile__title"),h=document.querySelector(".profile__description"),f=document.querySelector(".profile__image"),g=document.querySelector(".places__list"),S=document.querySelector(".popup_type_edit"),b=document.querySelector(".popup_type_new-card"),q=document.querySelector(".popup_type_image"),L=document.querySelector(".popup_type_avatar"),E=q.querySelector(".popup__image"),k=q.querySelector(".popup__caption"),C=document.querySelector(".profile__edit-button"),x=document.querySelector(".profile__add-button"),$=S.querySelector(".popup__form"),j=$.querySelector(".popup__button"),P=$.querySelector(".popup__input_type_name"),T=$.querySelector(".popup__input_type_description");P.value=y.textContent,T.value=h.textContent;const U=b.querySelector(".popup__form"),A=U.querySelector(".popup__button"),w=U.querySelector(".popup__input_type_card-name"),B=U.querySelector(".popup__input_type_url"),D=L.querySelector(".popup__form"),N=D.querySelector(".popup__button"),O=D.querySelector(".popup__input_type_url");let I;g.addEventListener("click",(e=>{if(e.target.classList.contains("card__image"))E.src="",E.src=e.target.src,k.textContent=e.target.alt,_(q);else if(e.target.classList.contains("card__like-button")){e.target.disabled=!0;const t=e.target.closest(".places__item");let r;r=e.target.classList.contains("card__like-button_is-active")?"DELETE":"PUT",((e,t)=>fetch(`${v.baseUrl}/cards/likes/${e}`,{method:t,headers:v.headers}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`))))(t.id,r).then((r=>{const o=(n=t,s=r.likes.length,n.querySelector(".card__like-count").textContent=s,n);var n,s;t.replaceWith(o),e.target.classList.toggle("card__like-button_is-active")})).catch((e=>{console.log(e)})).finally((()=>{e.target.disabled=!1}))}else if(e.target.classList.contains("card__delete-button")){e.target.disabled=!0;const r=e.target.closest(".places__item");(t=r.id,fetch(`${v.baseUrl}/cards/${t}`,{method:"DELETE",headers:v.headers}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))).then((e=>{r.remove()})).catch((e=>{console.log(e)}))}var t})),Promise.all([fetch(`${v.baseUrl}/users/me`,{headers:v.headers}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`))),fetch(`${v.baseUrl}/cards`,{headers:v.headers}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))]).then((e=>{let[r,o]=e;y.textContent=r.name,h.textContent=r.about,f.style.backgroundImage=`url(${r.avatar})`,I=r._id,o.forEach((e=>{const r=e.link,o=e.name,n=e.likes.length,s=e._id,a=t(r,o,n,s);e.likes.some((e=>e._id===I))&&a.querySelector(".card__like-button").classList.add("card__like-button_is-active"),e.owner._id!==I&&a.querySelector(".card__delete-button").classList.add("card__delete-button_diactivate"),g.append(a)}))})).catch((e=>{console.log(e)})),f.addEventListener("click",(e=>{O.value=f.style.backgroundImage.slice(5,-2),s(D,J),_(L)})),L.addEventListener("submit",(function(e){e.preventDefault(),N.textContent="Сохранение...";var t;(t={avatar:O.value},fetch(`${v.baseUrl}/users/me/avatar`,{method:"PATCH",headers:v.headers,body:JSON.stringify(t)}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))).then((e=>{f.style.backgroundImage=`url(${e.avatar})`,m(L)})).catch((e=>{console.log(e)})).finally((()=>{N.textContent="Сохранить"}))})),C.addEventListener("click",(e=>{P.value=y.textContent,T.value=h.textContent,s($,J),_(S)})),$.addEventListener("submit",(function(e){e.preventDefault(),j.textContent="Сохранение...";var t;(t={name:P.value,about:T.value},fetch(`${v.baseUrl}/users/me`,{method:"PATCH",headers:v.headers,body:JSON.stringify(t)}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))).then((e=>{y.textContent=e.name,h.textContent=e.about,m(S)})).catch((e=>{console.log(e)})).finally((()=>{j.textContent="Сохранить"}))})),x.addEventListener("click",(()=>{B.value="",w.value="",s(U,J),_(b)})),U.addEventListener("submit",(function(e){e.preventDefault(),A.textContent="Сохранение...";var r;(r={name:w.value,link:B.value},fetch(`${v.baseUrl}/cards`,{method:"POST",headers:v.headers,body:JSON.stringify(r)}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))).then((e=>{const r=e.link,o=e.name,n=e.likes.length,s=e._id,a=t(r,o,n,s);g.prepend(a),m(b)})).catch((e=>{console.log(e)})).finally((()=>{A.textContent="Сохранить"}))}));const J={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};(e=>{Array.from(document.querySelectorAll(e.formSelector)).forEach((t=>{((e,t)=>{const r=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);r.forEach((s=>{s.addEventListener("input",(()=>{n(e,s,t),a(r,o,t.inactiveButtonClass)}))}))})(t,e)}))})(J)})();